DateInput=function(a){function b(c,d){typeof d!="object"&&(d={}),a.extend(this,b.DEFAULT_OPTS,d),this.input=a(c),this.bindMethodsToObj("show","hide","hideIfClickOutside","keydownHandler","selectDate"),this.build(),this.selectDate(),this.hide()}return b.DEFAULT_OPTS={month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],short_day_names:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],start_of_week:1},b.prototype={build:function(){var b=a('<p class="month_nav"><span class="button prev" title="[Page-Up]">&#171;</span> <span class="month_name"></span> <span class="button next" title="[Page-Down]">&#187;</span></p>');this.monthNameSpan=a(".month_name",b),a(".prev",b).click(this.bindToObj(function(){this.moveMonthBy(-1)})),a(".next",b).click(this.bindToObj(function(){this.moveMonthBy(1)}));var c=a('<p class="year_nav"><span class="button prev" title="[Ctrl+Page-Up]">&#171;</span> <span class="year_name"></span> <span class="button next" title="[Ctrl+Page-Down]">&#187;</span></p>');this.yearNameSpan=a(".year_name",c),a(".prev",c).click(this.bindToObj(function(){this.moveMonthBy(-12)})),a(".next",c).click(this.bindToObj(function(){this.moveMonthBy(12)}));var d=a('<div class="nav"></div>').append(b,c),e="<table><thead><tr>";a(this.adjustDays(this.short_day_names)).each(function(){e+="<th>"+this+"</th>"}),e+="</tr></thead><tbody></tbody></table>",this.dateSelector=this.rootLayers=a('<div class="date_selector"></div>').append(d,e).insertAfter(this.input),a.browser.msie&&a.browser.version<7&&(this.ieframe=a('<iframe class="date_selector_ieframe" frameborder="0" src="#"></iframe>').insertBefore(this.dateSelector),this.rootLayers=this.rootLayers.add(this.ieframe),a(".button",d).mouseover(function(){a(this).addClass("hover")}),a(".button",d).mouseout(function(){a(this).removeClass("hover")})),this.tbody=a("tbody",this.dateSelector),this.input.change(this.bindToObj(function(){this.selectDate()})),this.selectDate()},selectMonth:function(b){var c=new Date(b.getFullYear(),b.getMonth(),1);if(!this.currentMonth||this.currentMonth.getFullYear()!=c.getFullYear()||this.currentMonth.getMonth()!=c.getMonth()){this.currentMonth=c;var d=this.rangeStart(b),e=this.rangeEnd(b),f=this.daysBetween(d,e),g="";for(var h=0;h<=f;h++){var i=new Date(d.getFullYear(),d.getMonth(),d.getDate()+h,12,0);this.isFirstDayOfWeek(i)&&(g+="<tr>"),i.getMonth()==b.getMonth()?g+='<td class="selectable_day" date="'+this.dateToString(i)+'">'+i.getDate()+"</td>":g+='<td class="unselected_month" date="'+this.dateToString(i)+'">'+i.getDate()+"</td>",this.isLastDayOfWeek(i)&&(g+="</tr>")}this.tbody.empty().append(g),this.monthNameSpan.empty().append(this.monthName(b)),this.yearNameSpan.empty().append(this.currentMonth.getFullYear()),a(".selectable_day",this.tbody).click(this.bindToObj(function(b){this.changeInput(a(b.target).attr("date"))})),a('td[date="'+this.dateToString(new Date)+'"]',this.tbody).addClass("today"),a("td.selectable_day",this.tbody).mouseover(function(){a(this).addClass("hover")}),a("td.selectable_day",this.tbody).mouseout(function(){a(this).removeClass("hover")})}a(".selected",this.tbody).removeClass("selected"),a('td[date="'+this.selectedDateString+'"]',this.tbody).addClass("selected")},selectDate:function(a){typeof a=="undefined"&&(a=this.stringToDate(this.input.val())),a||(a=new Date),this.selectedDate=a,this.selectedDateString=this.dateToString(this.selectedDate),this.selectMonth(this.selectedDate)},changeInput:function(a){this.input.val(a).change(),this.hide()},show:function(){this.rootLayers.css("display","block"),a([window,document.body]).click(this.hideIfClickOutside),this.input.unbind("focus",this.show),a(document.body).keydown(this.keydownHandler),this.setPosition()},hide:function(){this.rootLayers.css("display","none"),a([window,document.body]).unbind("click",this.hideIfClickOutside),this.input.focus(this.show),a(document.body).unbind("keydown",this.keydownHandler)},hideIfClickOutside:function(a){a.target!=this.input[0]&&!this.insideSelector(a)&&this.hide()},insideSelector:function(a){var b=this.dateSelector.position();return b.right=b.left+this.dateSelector.outerWidth(),b.bottom=b.top+this.dateSelector.outerHeight(),a.pageY<b.bottom&&a.pageY>b.top&&a.pageX<b.right&&a.pageX>b.left},keydownHandler:function(a){switch(a.keyCode){case 9:case 27:this.hide();return;case 13:this.changeInput(this.selectedDateString);break;case 33:this.moveDateMonthBy(a.ctrlKey?-12:-1);break;case 34:this.moveDateMonthBy(a.ctrlKey?12:1);break;case 38:this.moveDateBy(-7);break;case 40:this.moveDateBy(7);break;case 37:this.moveDateBy(-1);break;case 39:this.moveDateBy(1);break;default:return}a.preventDefault()},stringToDate:function(a){var b;return(b=a.match(/^(\d{1,2}) ([^\s]+) (\d{4,4})$/))?new Date(b[3],this.shortMonthNum(b[2]),b[1],12,0):null},dateToString:function(a){return a.getDate()+" "+this.short_month_names[a.getMonth()]+" "+a.getFullYear()},setPosition:function(){var a=this.input.offset();this.rootLayers.css({top:a.top+this.input.outerHeight(),left:a.left}),this.ieframe&&this.ieframe.css({width:this.dateSelector.outerWidth(),height:this.dateSelector.outerHeight()})},moveDateBy:function(a){var b=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth(),this.selectedDate.getDate()+a);this.selectDate(b)},moveDateMonthBy:function(a){var b=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth()+a,this.selectedDate.getDate());b.getMonth()==this.selectedDate.getMonth()+a+1&&b.setDate(0),this.selectDate(b)},moveMonthBy:function(a){var b=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()+a,this.currentMonth.getDate());this.selectMonth(b)},monthName:function(a){return this.month_names[a.getMonth()]},bindToObj:function(a){var b=this;return function(){return a.apply(b,arguments)}},bindMethodsToObj:function(){for(var a=0;a<arguments.length;a++)this[arguments[a]]=this.bindToObj(this[arguments[a]])},indexFor:function(a,b){for(var c=0;c<a.length;c++)if(b==a[c])return c},monthNum:function(a){return this.indexFor(this.month_names,a)},shortMonthNum:function(a){return this.indexFor(this.short_month_names,a)},shortDayNum:function(a){return this.indexFor(this.short_day_names,a)},daysBetween:function(a,b){return a=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),b=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()),(b-a)/864e5},changeDayTo:function(a,b,c){var d=c*(Math.abs(b.getDay()-a-c*7)%7);return new Date(b.getFullYear(),b.getMonth(),b.getDate()+d)},rangeStart:function(a){return this.changeDayTo(this.start_of_week,new Date(a.getFullYear(),a.getMonth()),-1)},rangeEnd:function(a){return this.changeDayTo((this.start_of_week-1)%7,new Date(a.getFullYear(),a.getMonth()+1,0),1)},isFirstDayOfWeek:function(a){return a.getDay()==this.start_of_week},isLastDayOfWeek:function(a){return a.getDay()==(this.start_of_week-1)%7},adjustDays:function(a){var b=[];for(var c=0;c<a.length;c++)b[c]=a[(c+this.start_of_week)%7];return b}},a.fn.date_input=function(a){return this.each(function(){new b(this,a)})},a.date_input={initialize:function(b){a("input.date_input").date_input(b)}},b}(jQuery)