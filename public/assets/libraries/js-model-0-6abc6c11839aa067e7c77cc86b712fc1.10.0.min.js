/*  js-model JavaScript library, version 0.10.0
 *  (c) 2010-2011 Ben Pickles
 *
 *  Released under MIT license.
 */
var Model=function(a,b){var c=function(b){this.attributes=jQuery.extend({},b),this.changes={},this.errors=new Model.Errors(this),this.uid=[a,Model.UID.generate()].join("-"),jQuery.isFunction(this.initialize)&&this.initialize()};return Model.Module.extend.call(c,Model.Module),c._name=a,c.collection=[],c.unique_key="id",c.extend(Model.Callbacks).extend(Model.ClassMethods).include(Model.Callbacks).include(Model.InstanceMethods),jQuery.isFunction(b)&&b.call(c,c,c.prototype),c};Model.Callbacks={bind:function(a,b){return this.callbacks=this.callbacks||{},this.callbacks[a]=this.callbacks[a]||[],this.callbacks[a].push(b),this},trigger:function(a,b){this.callbacks=this.callbacks||{};var c=this.callbacks[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b||[]);return this},unbind:function(a,b){this.callbacks=this.callbacks||{};if(b)for(var c=this.callbacks[a]||[],d=0;d<c.length;d++)c[d]===b&&this.callbacks[a].splice(d,1);else delete this.callbacks[a];return this}},Model.ClassMethods={add:function(){for(var a=[],b=0;b<arguments.length;b++){var c=arguments[b],d=c.id();jQuery.inArray(c,this.collection)===-1&&(!d||!this.find(d))&&(this.collection.push(c),a.push(c))}return a.length>0&&this.trigger("add",a),this},all:function(){return this.collection.slice()},chain:function(a){return jQuery.extend({},this,{collection:a})},count:function(){return this.all().length},detect:function(a){for(var b=this.all(),c,d=0,e=b.length;d<e;d++){c=b[d];if(a.call(c,c,d))return c}},each:function(a){for(var b=this.all(),c=0,d=b.length;c<d;c++)a.call(b[c],b[c],c);return this},find:function(a){return this.detect(function(){return this.id()==a})},first:function(){return this.all()[0]},load:function(a){if(this._persistence){var b=this;this._persistence.read(function(d){for(var e=0,f=d.length;e<f;e++)b.add(d[e]);a&&a.call(b,d)})}return this},last:function(){var a=this.all();return a[a.length-1]},map:function(a){for(var b=this.all(),c=[],d=0,e=b.length;d<e;d++)c.push(a.call(b[d],b[d],d));return c},persistence:function(a){if(arguments.length==0)return this._persistence;var b=Array.prototype.slice.call(arguments,1);return b.unshift(this),this._persistence=a.apply(a,b),this},pluck:function(a){for(var b=this.all(),c=[],d=0,e=b.length;d<e;d++)c.push(b[d].attr(a));return c},remove:function(a){for(var b,c=0,d=this.collection.length;c<d;c++)if(this.collection[c]===a){b=c;break}return b!=undefined?(this.collection.splice(b,1),this.trigger("remove",[a]),!0):!1},reverse:function(){return this.chain(this.all().reverse())},select:function(a){for(var b=this.all(),c=[],d,e=0,f=b.length;e<f;e++)d=b[e],a.call(d,d,e)&&c.push(d);return this.chain(c)},sort:function(a){return this.chain(this.all().sort(a))},sortBy:function(a){var b=jQuery.isFunction(a);return this.sort(function(d,e){var f=b?a.call(d):d.attr(a),g=b?a.call(e):e.attr(a);return f<g?-1:f>g?1:0})}},Model.Errors=function(a){this.errors={},this.model=a},Model.Errors.prototype={add:function(a,b){return this.errors[a]||(this.errors[a]=[]),this.errors[a].push(b),this},all:function(){return this.errors},clear:function(){return this.errors={},this},each:function(a){for(var b in this.errors)for(var c=0;c<this.errors[b].length;c++)a.call(this,b,this.errors[b][c]);return this},on:function(a){return this.errors[a]||[]},size:function(){var a=0;return this.each(function(){a++}),a}},Model.InstanceMethods={asJSON:function(){return this.attr()},attr:function(a,b){if(arguments.length===0)return jQuery.extend({},this.attributes,this.changes);if(arguments.length===2)return this.attributes[a]===b?delete this.changes[a]:this.changes[a]=b,this;if(typeof a=="object"){for(var c in a)this.attr(c,a[c]);return this}return a in this.changes?this.changes[a]:this.attributes[a]},callPersistMethod:function(a,b){var c=this,d=function(d){d&&(c.merge(c.changes).reset(),a==="destroy"?c.constructor.remove(c):c.constructor.add(c),c.trigger(a));var e;return b&&(e=b.apply(c,arguments)),e};this.constructor._persistence?this.constructor._persistence[a](this,d):d.call(this,!0)},destroy:function(a){return this.callPersistMethod("destroy",a),this},id:function(){return this.attributes[this.constructor.unique_key]},merge:function(a){return jQuery.extend(this.attributes,a),this},newRecord:function(){return this.id()===undefined},reset:function(){return this.errors.clear(),this.changes={},this},save:function(a){return this.valid()?this.callPersistMethod(this.newRecord()?"create":"update",a):a&&a(!1),this},valid:function(){return this.errors.clear(),this.validate(),this.errors.size()===0},validate:function(){return this}},Model.localStorage=function(a){if(!window.localStorage)return{create:function(a,b){b(!0)},destroy:function(a,b){b(!0)},read:function(a){a([])},update:function(a,b){b(!0)}};var b=[a._name,"collection"].join("-"),c=function(){var a=localStorage[b];return a?JSON.parse(a):[]},d=function(a){localStorage.setItem(a.uid,JSON.stringify(a.asJSON())),a=a.uid;var d=c();jQuery.inArray(a,d)===-1&&(d.push(a),localStorage.setItem(b,JSON.stringify(d)))};return{create:function(a,b){d(a),b(!0)},destroy:function(a,d){localStorage.removeItem(a.uid);var e=a.uid,f=c();e=jQuery.inArray(e,f),e>-1&&(f.splice(e,1),localStorage.setItem(b,JSON.stringify(f))),d(!0)},read:function(b){if(!b)return!1;for(var d=a.map(function(){return this.uid}),e=c(),f=[],g,h,i=0,j=e.length;i<j;i++)h=e[i],jQuery.inArray(h,d)==-1&&(g=JSON.parse(localStorage[h]),g=new a(g),g.uid=h,f.push(g));b(f)},update:function(a,b){d(a),b(!0)}}},Model.Log=function(){window.console&&window.console.log.apply(window.console,arguments)},Model.Module={extend:function(a){return jQuery.extend(this,a),this},include:function(a){return jQuery.extend(this.prototype,a),this}},Model.REST=function(a,b,c){var d=/:([\w\d]+)/g,e=function(){for(var a=[],c;(c=d.exec(b))!==null;)a.push(c[1]);return a}();return jQuery.extend({path:function(a){var c=b;return jQuery.each(e,function(b,d){c=c.replace(":"+d,a.attributes[d])}),c},create:function(a,b){return this.xhr("POST",this.create_path(a),a,b)},create_path:function(a){return this.path(a)},destroy:function(a,b){return this.xhr("DELETE",this.destroy_path(a),a,b)},destroy_path:function(a){return this.update_path(a)},params:function(a){var b;if(a){var c=a.asJSON();delete c[a.constructor.unique_key],b={},b[a.constructor._name.toLowerCase()]=c}else b=null;return jQuery.ajaxSettings.data&&(b=jQuery.extend({},jQuery.ajaxSettings.data,b)),JSON.stringify(b)},read:function(b){return this.xhr("GET",this.read_path(),null,function(c,d,e){e=jQuery.makeArray(e),c=[],d=0;for(var f=e.length;d<f;d++)c.push(new a(e[d]));b(c)})},read_path:function(){return b},update:function(a,b){return this.xhr("PUT",this.update_path(a),a,b)},update_path:function(a){return[this.path(a),a.id()].join("/")},xhr:function(a,b,c,d){var e=this,f=a=="GET"?undefined:this.params(c);return jQuery.ajax({type:a,url:b,contentType:"application/json",dataType:"json",data:f,dataFilter:function(a){return/\S/.test(a)?a:undefined},complete:function(a,b){e.xhrComplete(a,b,c,d)}})},xhrComplete:function(a,b,c,d){var e=Model.REST["handle"+a.status];e&&e.call(this,a,b,c),b=b==="success",e=Model.REST.parseResponseData(a),b&&c&&e&&c.attr(e),d&&d.call(c,b,a,e)}},c)},Model.RestPersistence=Model.REST,Model.REST.handle422=function(a,b,c){if(a=Model.REST.parseResponseData(a)){c.errors.clear();for(var d in a)for(b=0;b<a[d].length;b++)c.errors.add(d,a[d][b])}},Model.REST.parseResponseData=function(a){try{return/\S/.test(a.responseText)?jQuery.parseJSON(a.responseText):undefined}catch(b){Model.Log(b)}},Model.UID={counter:0,generate:function(){return[(new Date).valueOf(),this.counter++].join("-")},reset:function(){return this.counter=0,this}},Model.VERSION="0.10.0"